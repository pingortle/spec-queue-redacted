version: "2.1"

services:
  get-server-secrets:
    image: abesiyo/s3
    volumes:
      - ./server:/workspace
    working_dir: /workspace
    environment:
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION}
    command: cp s3://cas-spec-queue-secrets ./.deploy --recursive

  deploy-server:
    build:
      context: ./server
      dockerfile: meteor-command.Dockerfile
    volumes:
      - ./server/.deploy:/workspace
    working_dir: /workspace
    command: bash -c "mup setup && mup deploy"

  test-server:
    build:
      context: ./server
      dockerfile: meteor-command.Dockerfile
    volumes:
      - ./server:/workspace
    working_dir: /workspace
    command: /bin/bash -c "meteor npm install && meteor test --once --driver-package dispatch:mocha"
